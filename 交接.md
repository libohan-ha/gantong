## 项目交接说明（单一 Markdown 文档）

本说明覆盖前后端主要模块、接口规格、请求/响应示例、运行与部署要点，便于他人接手维护与扩展。内容均基于当前仓库代码梳理（未对代码做任何改动）。

---

## 1. 项目总览

### 1.1 技术与目录
- 前端：Vue 3 + Vite + Pinia + Element Plus
  - 入口与路由：frontend/src/router/index.ts
  - 页面视图：frontend/src/views/*
  - 服务层：frontend/src/services/*
- 后端：NestJS + TypeORM + PostgreSQL
  - 模块/控制器：backend/src/*（growth, trainings, videos, doctors, auth 等）
  - 实体与迁移：backend/src/**/entities, backend/src/migrations
  - 启动入口：backend/src/main.ts（CORS 已启用；uploads 静态目录）

### 1.2 角色与权限
- 角色：PARENT（家长）、DOCTOR（医生）、HOSPITAL_ADMIN、SUPER_ADMIN
- 后端鉴权：
  - 统一 JWT（JwtAuthGuard）
  - 需角色限制的路由使用 RolesGuard + @Roles
  - parent/growth（家长成长档案）控制器仅使用 JWT 守卫，不强制角色为 PARENT；但前端路由限制进入需 PARENT
- 前端路由 meta 中限制各路由可访问角色

### 1.3 运行与调试

前端（frontend/package.json）
- 开发：npm run dev
- 构建：npm run build
- 预览：npm run preview
- 类型检查：npm run type-check
- 测试：npm run test:unit / test:e2e

后端（backend/package.json）
- 开发：npm run start:dev
- 构建：npm run build
- 运行：npm run start
- 迁移：npm run typeorm:run
- 种子：npm run seed:superadmin

Axios baseURL：frontend/src/services/api.ts → http://localhost:3000

---

## 2. 前端路由与服务对照

- /parent/growth-profile → GrowthProfileView.vue
  - 服务：src/services/growth.ts（孩子/档案/健康记录 API）
- /hospital → HospitalView.vue（医院端聚合页）
- /hospital/training-management → TrainingManagementView.vue
  - 服务：src/services/trainings.ts（医生培训管理）
- /hospital/video-upload → VideoUploadView.vue
  - 服务：src/services/video.ts（视频上传/我的视频）
- /doctor/profile → DoctorProfileView.vue
  - 服务：src/services/doctor.ts（医生资料/统计）
- /parent/expert-courses → ExpertCoursesView.vue
  - 服务：src/services/video.ts（家长端公开课程/流式播放）

---

## 3. 后端 API 规格与示例

说明格式：Method 路径（鉴权/角色）— 请求体/查询 — 响应示例

提示：
- 401：未登录；403：权限不足/非本人资源；404：资源不存在；400/422：参数或校验错误
- 所有请求需 Authorization: Bearer <token>（除非明确公开）

### 3.1 家长端·成长档案（ParentGrowthController）

控制器：backend/src/growth/parent-growth.controller.ts  
守卫：JwtAuthGuard（按代码未强制角色为 PARENT；前端路由限制 PARENT）

1) 列出孩子  
GET /parent/growth/children（JWT）
- Response
```json
{
  "items": [
    { "id": 1, "name": "小明", "gender": "男", "birthDate": "2020-05-20", "avatarUrl": null }
  ]
}
```

2) 创建孩子  
POST /parent/growth/children（JWT）
- Request
```json
{ "name": "小明", "gender": "男", "birthDate": "2020-05-20" }
```
- Response
```json
{ "id": 1, "name": "小明", "gender": "男", "birthDate": "2020-05-20", "avatarUrl": null }
```

3) 获取成长档案  
GET /parent/growth/children/:childId/profile（JWT）
- Response
```json
{
  "child": { "id": 1, "name": "小明", "gender": "男", "birthDate": "2020-05-20" },
  "currentStatus": {
    "physicalDevelopment": { "height": 110, "weight": 16, "lastUpdated": "2025-08-18" },
    "behaviorObservation": {
      "strengths": ["配合度高"], "challenges": ["注意力分散"], "improvements": ["沟通增强"]
    },
    "dailySkills": { "selfCare": 11, "communication": 11, "social": 11, "motor": 11 }
  }
}
```

4) 保存成长档案（部分字段任选）  
PUT /parent/growth/children/:childId/profile（JWT）
- Request
```json
{
  "heightCm": 110,
  "weightKg": 16,
  "lastPhysicalUpdated": "2025-08-18",
  "behaviorStrengths": ["配合度高"],
  "behaviorChallenges": ["注意力分散"],
  "behaviorImprovements": ["沟通增强"],
  "dailySelfCare": 11,
  "dailyCommunication": 11,
  "dailySocial": 11,
  "dailyMotor": 11
}
```
- Response（同“获取成长档案”）

5) 健康记录列表  
GET /parent/growth/children/:childId/health-records?page=1&pageSize=20（JWT）
- Response
```json
{
  "items": [
    { "id": 10, "childId": 1, "date": "2025-08-18", "type": "体检", "description": "常规检查", "result": "正常" }
  ],
  "total": 1,
  "page": 1,
  "pageSize": 20
}
```

6) 新增健康记录  
POST /parent/growth/children/:childId/health-records（JWT）
- Request
```json
{ "date": "2025-08-18", "type": "体检", "description": "常规检查", "result": "正常" }
```
- Response
```json
{ "id": 10, "childId": 1, "date": "2025-08-18", "type": "体检", "description": "常规检查", "result": "正常" }
```

7) 更新健康记录  
PUT /parent/growth/health-records/:recordId（JWT）
- Request
```json
{ "description": "复查建议", "result": "良好" }
```
- Response
```json
{ "id": 10, "childId": 1, "date": "2025-08-18", "type": "体检", "description": "复查建议", "result": "良好" }
```

8) 删除健康记录  
DELETE /parent/growth/health-records/:recordId（JWT）
- Response
```json
{ "success": true }
```

示例 curl（保存档案）
- curl -X PUT http://localhost:3000/parent/growth/children/1/profile -H "Authorization: Bearer TOKEN" -H "Content-Type: application/json" -d '{"heightCm":110,"weightKg":16,"lastPhysicalUpdated":"2025-08-18","dailySelfCare":11}'

字段校验（后端 dto/profile.dto.ts）
- heightCm 20–200、weightKg 5–100、lastPhysicalUpdated 为 YYYY-MM-DD
- 行为标签数组长度与单项长度限制；daily* 0–100

---

### 3.2 医生资料（DoctorsController）

控制器：backend/src/doctors/doctors.controller.ts  
守卫：JwtAuthGuard

1) 获取我的医生资料  
GET /doctors/me/profile（JWT）
- Response
```json
{
  "userId": 1001,
  "name": "张医生",
  "hospital": "北京儿童医院",
  "title": "主任医师",
  "age": 45,
  "phone": "13800138000",
  "verified": false
}
```

2) 更新我的医生资料  
PATCH /doctors/me/profile（JWT）
- Request（任意字段可选）
```json
{ "name": "李医生", "hospital": "上海儿童医院", "title": "副主任医师", "age": 40, "phone": "13900000000" }
```
- Response（更新后）
```json
{ "userId": 1001, "name": "李医生", "hospital": "上海儿童医院", "title": "副主任医师", "age": 40, "phone": "13900000000", "verified": false }
```

3) 获取我的统计信息  
GET /doctors/me/stats（JWT）
- Response
```json
{ "videoCount": 0, "totalViews": 0, "totalLikes": 0, "profileCompleteness": 100 }
```

错误说明
- 手机号等唯一约束冲突返回 409（CONFLICT）

---

### 3.3 医生端·培训管理（TrainingsController）

控制器：backend/src/trainings/trainings.controller.ts  
守卫：JwtAuthGuard + RolesGuard（@Roles(DOCTOR)）

实体：backend/src/trainings/entities/training.entity.ts

1) 创建培训  
POST /trainings（DOCTOR）
- Request（CreateTrainingDto）
```json
{
  "title": "感统评估培训",
  "description": "课程介绍",
  "type": "online",
  "durationHours": 4,
  "maxParticipants": 200,
  "startDate": "2025-09-01T09:00:00Z"
}
```
- Response
```json
{
  "id": 12,
  "doctorUserId": 1001,
  "title": "感统评估培训",
  "description": "课程介绍",
  "type": "online",
  "durationHours": 4,
  "maxParticipants": 200,
  "startDate": "2025-09-01T09:00:00.000Z",
  "createdAt": "2025-08-01T10:00:00.000Z",
  "updatedAt": "2025-08-01T10:00:00.000Z"
}
```

2) 查看我的培训列表  
GET /trainings/mine?page=1&pageSize=10（DOCTOR）
- Response
```json
{
  "items": [
    {
      "id": 12,
      "doctorUserId": 1001,
      "title": "感统评估培训",
      "description": "课程介绍",
      "type": "online",
      "durationHours": 4,
      "maxParticipants": 200,
      "startDate": "2025-09-01T09:00:00.000Z",
      "createdAt": "2025-08-01T10:00:00.000Z",
      "updatedAt": "2025-08-01T10:00:00.000Z",
      "doctor": { "id": 1001, "username": "doc1", "doctorProfile": { "title": "主任医师", "hospital": "北京儿童医院" } }
    }
  ],
  "total": 1,
  "page": 1,
  "pageSize": 10
}
```

3) 查看单个培训（仅本人）  
GET /trainings/:id（DOCTOR）
- Response：Training（同上结构，含 doctor.doctorProfile）

4) 编辑培训（仅本人）  
PATCH /trainings/:id（DOCTOR）
- Request（UpdateTrainingDto，任意字段可选）
```json
{ "title": "感统评估培训（更新）", "maxParticipants": 300 }
```
- Response：更新后的 Training

5) 删除培训（仅本人）  
DELETE /trainings/:id（DOCTOR）
- Response
```json
{ "success": true }
```

---

### 3.4 家长端·培训公开查询与预约（ParentExpertsController / ParentBookingsController）

控制器：backend/src/trainings/parent-experts.controller.ts, parent-bookings.controller.ts  
守卫：列表/详情公开接口未声明角色守卫；预约提交需 JWT（实际业务通常要求 PARENT）

1) 培训列表（家长端）  
GET /parent/experts/trainings?page=1&pageSize=10&q=关键字&type=online
- Response
```json
{
  "items": [
    {
      "id": 12,
      "doctorUserId": 1001,
      "title": "感统评估培训",
      "description": "课程介绍",
      "type": "online",
      "durationHours": 4,
      "maxParticipants": 200,
      "startDate": "2025-09-01T09:00:00.000Z",
      "doctor": { "id": 1001, "doctorProfile": { "name": "张医生", "hospital": "北京儿童医院", "title": "主任医师" } }
    }
  ],
  "total": 1,
  "page": 1,
  "pageSize": 10
}
```

2) 培训详情  
GET /parent/experts/trainings/:id
- Response：Training（含 doctor.doctorProfile）

3) 有培训的医生聚合  
GET /parent/experts/doctors?page=1&pageSize=10&q=关键字
- Response
```json
{
  "items": [
    { "doctorId": 1001, "name": "张医生", "title": "主任医师", "hospital": "北京儿童医院", "nextStartAt": "2025-09-01T09:00:00.000Z", "trainingsCount": 3 }
  ],
  "total": 1,
  "page": 1,
  "pageSize": 10
}
```

4) 提交预约（免费，单场次）  
POST /parent/experts/bookings（JWT）
- Request（CreateTrainingBookingDto）
```json
{
  "trainingId": 12,
  "childName": "小明",
  "childAge": 5,
  "childGender": "男",
  "parentName": "王女士",
  "parentPhone": "13800138000",
  "preferredDate": "2025-08-30",
  "preferredTime": "上午",
  "symptoms": "注意力不集中",
  "previousTreatment": "无"
}
```
- 规则：只允许预约“今天及以后”的培训（否则 400）
- Response
```json
{ "id": 5001, "success": true }
```

---

### 3.5 医生端·视频与家长端课程（VideosController）

控制器：backend/src/videos/videos.controller.ts

医生端（需 DOCTOR）
1) 上传视频（表单上传）  
POST /videos（JWT+DOCTOR，multipart/form-data）
- FormData 字段
  - file: 二进制视频文件
  - title, description, category, difficulty, tags[], targetAudience[]
- Response（视频记录）
```json
{
  "id": 300,
  "authorUserId": 1001,
  "title": "课程标题",
  "description": "课程介绍",
  "category": "康复",
  "tags": ["感统","家庭训练"],
  "targetAudience": ["家长","治疗师"],
  "difficulty": "beginner",
  "fileName": "xxx.mp4",
  "fileSizeBytes": 12345678,
  "storagePath": "uploads/videos/xxx.mp4",
  "status": "published",
  "viewCount": 0,
  "likeCount": 0,
  "downloadCount": 0,
  "createdAt": "2025-08-01T10:00:00.000Z",
  "updatedAt": "2025-08-01T10:00:00.000Z"
}
```

2) 我的影片列表  
GET /videos/mine?page=1&pageSize=10（JWT+DOCTOR）
- Response：分页列表（含统计字段等）

3) 我的影片详情  
GET /videos/:id（JWT+DOCTOR）
- Response：单条视频

4) 更新视频  
PATCH /videos/:id（JWT+DOCTOR）
- Request（UpdateVideoDto，字段任选）
```json
{ "title": "课程标题（更新）", "description": "简介更新", "tags": ["感统","亲子"] }
```

5) 删除视频  
DELETE /videos/:id（JWT+DOCTOR）
- Response
```json
{ "message": "视频删除成功" }
```

家长端课程（需 PARENT）
6) 课程列表  
GET /client/expert-courses?page=1&pageSize=10 …

7) 课程详情（会自增播放量）  
GET /client/expert-courses/:id

8) 流式播放（断点续传）  
GET /client/expert-courses/:id/stream  
- 支持 Range: bytes=… 请求头，返回 206 分片或 200 全量流

示例 curl（上传）：
- curl -X POST http://localhost:3000/videos -H "Authorization: Bearer TOKEN" -F "file=@/path/video.mp4" -F "title=示例" -F "category=康复" -F "difficulty=beginner" -F "tags=感统" -F "targetAudience=家长"

---

## 4. 数据模型与迁移（摘要）

核心实体（字段取自实体文件）

- children（Child）
  - id, parentUserId, name, gender('男'|'女'|'未知'), birthDate, avatarUrl, createdAt, updatedAt
- growth_profiles（GrowthProfile）
  - childId(PK), heightCm, weightKg, lastPhysicalUpdated(date)
  - behaviorStrengths[], behaviorChallenges[], behaviorImprovements[]
  - dailySelfCare/Communication/Social/Motor（0–100），createdAt/updatedAt
- trainings（Training）
  - id, doctorUserId, title, description, type('online'|'offline'|'hybrid'), durationHours, maxParticipants, startDate(timestamptz), createdAt, updatedAt
- training_bookings（TrainingBooking）
  - id, parentUserId, doctorUserId, trainingId, status('submitted'|'canceled')
  - childName/childAge/childGender, parentName/parentPhone, preferredDate/Time, symptoms, previousTreatment, createdAt
- videos（Video）
  - id, authorUserId, title, description, category, tags[], targetAudience[], difficulty, fileName, fileSizeBytes, storagePath, status
  - authorSnapshotName/hospital/title，viewCount/likeCount/downloadCount，createdAt/updatedAt
- doctor_profiles（DoctorProfile）
  - userId(PK), name, hospital, title?, age?, phone?, verified

迁移文件（backend/src/migrations）
- 1742231000000-CreateGrowthModule.ts（成长档案/children 等）
- 1742220000000-CreateTrainingsTable.ts（培训）
- 1742230000000-CreateTrainingBookings.ts（预约）
- 1742210000000-CreateCasesTables.ts（病例相关基础）

执行迁移：npm run typeorm:run

---

## 5. 部署与环境

- 后端环境变量（参考 AppModule/数据库配置，自行补充 DB 连接、JWT 密钥、uploads 目录等）
- 端口：默认 3000
- 静态资源：/static/ 指向 uploads 目录（main.ts）
- CORS：启用，origin: true
- 前端 Axios 指向 http://localhost:3000；登录态保存在 localStorage（accessToken, user）

---

## 6. 验收清单与 TODO

验收路径
- 家长端：创建孩子 → 选择孩子 → 编辑并保存档案 → 健康记录增删改查
- 医生端：完善资料 → 创建培训 → 我的培训列表 → 编辑/删除
- 视频：医生上传 → 我的影片可见 → 家长端课程列表/详情 → 流式播放

待完善（建议在后续版本补充）
- 医院/医生端“预约处理后台”：查询预约、状态流转（确认/取消等）API（当前仅家长提交预约）
- 病例隐私上传模块的隐私策略与权限说明（前端 HospitalView 有入口；后端 cases 模块可对齐）
- 视频转码/大小限制/存储策略（multer 配置已具雏形，可在文档中补细则）


